edition = "2023";

package dev.warashi.muscat.v1;

option go_package = "github.com/Warashi/muscat/v2/pb";

message OpenRequest {
  string uri = 1;
}
message OpenResponse {}

message CopyRequest {
  bytes body = 1;
}

message CopyResponse {}

message PasteRequest {}
message PasteResponse {
  bytes body = 1;
}

message HealthRequest {}

message HealthResponse {
  int64 pid = 1;
}

message GetInputMethodRequest {}

message GetInputMethodResponse {
  string id = 1;
}

message SetInputMethodRequest {
  string id = 1;
}

message SetInputMethodResponse {
  string before = 1;
}

// PortForwardRequest.body is a body of transferred data.
message PortForwardRequest {
  bytes body = 1;
}

// PortForwardResponse.body is a body of transferred data.
message PortForwardResponse {
  bytes body = 1;
}

message ExposePortInit {
  uint32 local_port = 1;
  uint32 remote_port = 2;
  string bind_address = 3;
  bool public = 4;
}

message ExposePortConnectionOpen {
  uint64 connection_id = 1;
  uint32 remote_port = 2;
  string remote_address = 3;
}

message ExposePortConnectionData {
  uint64 connection_id = 1;
  bytes payload = 2;
}

message ExposePortConnectionClose {
  uint64 connection_id = 1;
  string error = 2;
  bool reset = 3;
}

message ExposePortError {
  string message = 1;
}

message ExposePortRequest {
  oneof frame {
    ExposePortInit init = 1;
    ExposePortConnectionData data = 2;
    ExposePortConnectionClose close = 3;
  }
}

message ExposePortResponse {
  oneof frame {
    ExposePortConnectionOpen open = 1;
    ExposePortConnectionData data = 2;
    ExposePortConnectionClose close = 3;
    ExposePortError error = 4;
  }
}

message ExecRequest {
  string command = 1;
  repeated string args = 2;
  bytes stdin = 3;
}

message ExecResponse {
  bytes stdout = 1;
  bytes stderr = 2;
  int32 exit_code = 3;
}

service MuscatService {
  rpc Health(HealthRequest) returns (HealthResponse);

  rpc Open(OpenRequest) returns (OpenResponse);

  rpc Copy(stream CopyRequest) returns (CopyResponse);
  rpc Paste(PasteRequest) returns (stream PasteResponse);

  rpc GetInputMethod(GetInputMethodRequest) returns (GetInputMethodResponse);
  rpc SetInputMethod(SetInputMethodRequest) returns (SetInputMethodResponse);

  // PortForward is a bidirectional stream.
  // Forwarded port is send as metadata.
  // 1 connection is 1 stream.
  rpc PortForward(stream PortForwardRequest) returns (stream PortForwardResponse);

  // ExposePort exposes local listener on the client to the server.
  rpc ExposePort(stream ExposePortRequest) returns (stream ExposePortResponse);

  rpc Exec(ExecRequest) returns (ExecResponse);
}
